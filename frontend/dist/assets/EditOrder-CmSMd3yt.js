import{d as e,C as a,r as t,m as r,o as l,j as i,k as d,a as u,q as s,c as o,b as n,B as c,e as p}from"./index-BChQAjBg.js";import{_ as v}from"./PageBreadcrumb.vue_vue_type_script_setup_true_lang-CiMPynWi.js";import{_ as m}from"./AdminLayout-BDbNDvIA.js";import{_ as y}from"./ComponentCard.vue_vue_type_script_setup_true_lang-CxALZE3h.js";import{_ as b}from"./Form.vue_vue_type_script_setup_true_lang-Dj0hsM9h.js";import"./_plugin-vue_export-helper-BCo6x5W8.js";const f={key:0,class:"flex items-center justify-center py-12"},_={key:1,class:"space-y-6"},h=e({__name:"EditOrder",setup(e){const h=a(),I=c(),g=h.params.id,k=t("Edit Order"),P=t(!1),q=t(!1),D=t({}),O=t([]),w=t([]),C=t(null),A=r(()=>[{key:"userId",type:"select",label:"Customer",required:!0,options:Array.isArray(O.value)?O.value.map(e=>({label:`${e.name} (${e.email})`,value:e._id})):[]},{key:"cartItems",type:"array",label:"Order Items",required:!0,minItems:1,fields:[{key:"productId",type:"select",label:"Product",required:!0,options:Array.isArray(w.value)?w.value.map(e=>{var a;return{label:(null==(a=e.title)?void 0:a.en)||e.name||"Unknown",value:e._id}}):[]},{key:"quantity",type:"number",label:"Quantity",required:!0,min:1},{key:"price",type:"number",label:"Price (KWD)",required:!0,min:0,step:.01,hint:"Auto-filled from product, but you can edit it"}]},{key:"paymentMethod",type:"select",label:"Payment Method",required:!0,options:[{label:"Cash",value:"cash"},{label:"Card",value:"card"},{label:"Knet",value:"knet"},{label:"Mastercard",value:"mastercard"}]},{key:"status",type:"select",label:"Order Status",required:!0,options:[{label:"Pending",value:"pending"},{label:"Under Preparation",value:"under_preparation"},{label:"Under Delivery",value:"under_delivery"},{label:"Delivered",value:"delivered"},{label:"Cancelled",value:"cancelled"},{label:"Refunded",value:"refunded"}]},{key:"isPaid",type:"switch",label:"Payment Completed"},{key:"isDelivered",type:"switch",label:"Delivered"},{key:"totalOrderPrice",type:"number",label:"Total Order Price (KWD)",required:!0,min:0,step:.01,hint:"Auto-calculated from items, but you can edit it"}]),j=(e,a,t)=>{var r,l,i,d;if(e.includes("cartItems")&&e.includes("productId")){const t=e.match(/cartItems\[(\d+)\]\.productId/);if(t){const e=parseInt(t[1]),u=(d=a,w.value.find(e=>e._id===d));if(u&&(null==(i=null==(l=null==(r=C.value)?void 0:r.formData)?void 0:l.cartItems)?void 0:i[e])){const a=u.price||u.priceBeforeOffer||0;C.value.formData.cartItems[e].price=a}}}(e.includes("cartItems")||"cartItems"===e)&&setTimeout(()=>{var e,a;if(null==(e=C.value)?void 0:e.formData){const e=(a=C.value.formData.cartItems||[],Array.isArray(a)&&0!==a.length?a.reduce((e,a)=>e+(Number(a.quantity)||0)*(Number(a.price)||0),0):0);C.value.formData.totalOrderPrice=parseFloat(e.toFixed(2))}},100)},x=async()=>{var e,a;P.value=!0;try{const{data:t}=await u.get(`/orders/${g}`),r=null==t?void 0:t.data;r&&(D.value={userId:(null==(e=r.userId)?void 0:e._id)||r.userId,cartItems:(null==(a=r.cartItems)?void 0:a.map(e=>{var a;return{productId:(null==(a=e.productId)?void 0:a._id)||e.productId,quantity:e.quantity,price:e.price}}))||[],paymentMethod:r.paymentMethod,status:r.status,isPaid:r.isPaid,isDelivered:r.isDelivered,totalOrderPrice:r.totalOrderPrice})}catch(t){console.error("Failed to fetch order:",t)}finally{P.value=!1}},F=async()=>{var e;try{const{data:a}=await u.get("/users");O.value=(null==(e=null==a?void 0:a.data)?void 0:e.users)||(null==a?void 0:a.users)||(null==a?void 0:a.data)||[]}catch(a){console.error("Failed to fetch users:",a)}},M=async()=>{var e;try{const{data:a}=await u.get("/products");w.value=(null==(e=null==a?void 0:a.data)?void 0:e.products)||(null==a?void 0:a.products)||(null==a?void 0:a.data)||[]}catch(a){console.error("Failed to fetch products:",a)}},T=async e=>{q.value=!0;try{await u.put(`/orders/${g}`,e),I.push("/orders")}catch(a){console.error("Failed to update order:",a)}finally{q.value=!1}},U=()=>{I.push("/orders")};return l(async()=>{await Promise.all([F(),M(),x()])}),(e,a)=>(p(),i(m,null,{default:d(()=>[s(v,{pageTitle:k.value},null,8,["pageTitle"]),P.value?(p(),o("div",f,[...a[0]||(a[0]=[n("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-brand-500"},null,-1)])])):(p(),o("div",_,[s(y,{title:"Edit Order"},{default:d(()=>[s(b,{ref_key:"formRef",ref:C,fields:A.value,"initial-data":D.value,"show-submit-button":!0,"submit-button-text":"Update Order","show-reset-button":!0,"reset-button-text":"Cancel",loading:q.value,onSubmit:T,onReset:U,onChange:j},null,8,["fields","initial-data","loading"])]),_:1})]))]),_:1}))}});export{h as default};
